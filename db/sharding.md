# 分库分表

为什么要分表、为什么要分库呢？

以mysql的主键索引为例，使用的是B+树，根据B+树的特点，它的叶子节点存储的是实际的数据，非叶子节点存储索引和指针，mysql将B+树的一个节点大小控制为一页大小（把BTree树的一个节点大小设计为一个存储单元即为一页（16K）），每一次IO读取的数据刚好为一页，即每次磁盘IO刚好读取B+树的一个节点内容，那么一个3层的B+树需要3次磁盘IO才能查找到对应的数据，而磁盘IO的成本是比较高的，为了有较好的性能，我们肯定也希望IO次数越少越好，所以我们以3层的B+树为例（3层及以下都有较高的性能），那么它能存储多少数据量有多少呢？

假设我们的表中一条记录大小为1K，那么B+树一个叶子节点可以存储，16K/1K=16条记录，而非叶子节点，只存储索引和指针，以主键bigint为例长度8字，指针大小为6字节，共14字节，一页大小 16K = 16384字节，所以一个非叶子节点可以存储索引数为 16384/14 = 1170 ，则一个3层的B+数可以存放 1170 * 1170 * 16 = 21902400条记录，也就是说2000万以下任意的数据量，3层的B+树都需要3次IO，性能没多大区别，如果层次越深，IO次数越多，性能也就越低。

当然单表的数据量2190W 是理论数据量，实际应用中一条记录的大小可能不止1K，那数据量可能就会更少。

就以我个人的经验来说，单表的数据量达到700W以上，性能就会有所下降（当然这只是我个人在开发中遇到过这样的问题）

随着数据量的增长，当单表使用主键查询的时候都很慢的情况下，我们就不得不考虑分库分表了。

分库和分表并非要同时存在，有的时候我们可能只需要分表就够了，有的时候我们可能只需要分库，比如读写分离库等。

那么为什么要分库呢？

单表有写入或者查询等性能问题需要分表，那么分库又是为了什么呢？

其实，就像我们的应用系统一样，为什么要把应用系统部署多个服务器，那是因为单个服务器的性能不够，并发请求量高的时候已经无法满足了，数据库也有同样的问题，毕竟它也是部署在服务器上的，当并发请求数高的时候，单个数据库已经不能不能满足更高的并发请求时，就不得不进行分库了。


 **分表** 

即把单表的数据拆分到多张表中，表的结构是相同的。像我们的业务系统十几年前就遇到了单表查询性能问题，当时的做法是每到新的月份时，建一张历史表（表名+月份明白），然后将当前表中的数据复制到历史表中去，查询分为当前数据查询和历史数据查询，好处是没有查询性能问题了，坏处是业务变的复杂了，还有就是打开数据库你会看到几百张相同前缀的表。

 **分库**

分库，两个库可以数据完全相同比如读写分离库，写的时候在一个库，读的时候从另外一个库读，这种情况要求两个库的数据完全一致。另外也可以用作分割数据，比如把一部分数据存在这个库上，另一部分数据放在另一个库上等。

# 分库分表方案
 

参考：

https://www.cnblogs.com/leefreeman/p/8315844.html
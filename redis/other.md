# 缓存穿透、缓存雪崩、缓存击穿，数据库和缓存一致性问题是如何解决？

#### 缓存穿透

大量的请求访问的key在系统中是不存在的，因为系统中没有，redis中肯定没有，所以请求直接落到了数据库，导致缓存失效，数据库承受了大量的压力，对系统造成了影响；

##### 如何解决:
 
1. 把无效的Key存进Redis中。如果Redis查不到数据，数据库也查不到，我们把这个Key值保存进Redis，设置value= null ，当下次再通过这个Key查询时就不需要再查询数据库。当然这种方式只能杜绝相同的key，假如传进来的这个不存在的Key值每次都是随机的，那存进Redis也没有意义。

2. 布隆过滤器，最开始的章节已经提到了redis中有布隆过滤器这种东西，那么可以将系统中的key在布隆过滤器中先存一边，请求的时候先查询布隆过滤器中是否存在，存在的情况再进行查询redis中的key，不存在的话查询数据库，这样可以过滤掉大部分的请求；

#### 缓存击穿

某些热点的key，因为经常要被访问所以有大量的请求（例如微博的热搜），由于过期策略或者其他原因等导致某个时刻全部突然失效了，一瞬间请求全部落到了数据库上，这种情况被称为缓存击穿；

##### 如何解决：

1. 针对这些热点key，在原来过期的基础上加上随机的过期时间，比如再加上1~5分钟，这样的话不会使得热点key同时过期；

2. 如果业务允许，可以将key设置为永不过期；

3. 加锁，某个请求过来的时候，如果发现缓存不存在则加锁，之后从数据库读取数据，读取完之后写入到缓存中；其他请求过来的时候发现缓存中不存在，检查锁标志，进行阻塞或者返回等。这样的话只会有一个请求读取数据库，读完之后又写入到了缓存，其他的要么等待，要么之后从缓存中读取到了数据。

4. 熔断限流等，对于这类接口进行流量限制等，这样即使发送大量请求，也只有少部分请求能进来，数据库的压力也就没那么大了。


#### 缓存雪崩

大规模的缓存失效或者缓存服务宕机，导致请求全部落到了数据库，给数据库造成压力，甚至可能崩溃，缓存和数据库都用不了，系统也就瘫痪了，引起雪崩效应，这种情况称为缓存雪崩

##### 如何解决：

1. 如果是缓存服务宕机引起的，则需要提高redis服务的可用性，如果是单机的可以尝试使用主从，哨兵，集群等模式。

2. 如果是缓存穿透或者缓存击穿等引起的，把上面两个的解决方案回答一遍即可。

3. 除此之外还要提高数据库本身的容灾能力，如：分库分表，读写分离等。

#### 数据库和缓存一致性问题？

只要使用缓存就不可避免的存在一致性问题，当然在采用缓存过期的情况下，可以使得数据库和缓存之间达到最终一致性。

缓存和数据库之间的操作分下面几种情况：

1. 假如先删除缓存，再更新数据库，在缓存删除成功到数据库更新提交事务之前，这一段时间里如果有请求过来，发现缓存里没有数据，从数据库中读取（此时还是旧数据），结果就造成了缓存和数据库之间的不一致性

2. 假如先更新数据库，更新成功后删除缓存，这时如果缓存删除失败，导致缓存中仍然是旧数据，这也会引起不一致。

相比第一种情况，先更新数据库后删除缓存要好的多，如果删除缓存失败了，可以用后续任务或者其他手段，持续尝试删除；

当然在读写分离数据库的情况下，先更新数据库后删除缓存也会有问题，某个请求发现缓存中不存在，从数据库中读取，这个时候 主库先写成功，但是还没有同步到从库，导致读取的从库仍然是旧数据，所以缓存和数据库之间又不一致了。

解决方法仍然是先更新数据库后删除缓存，在之后再加上一段时间的休眠或者通过任务或者延迟的消息等，再删除一次缓存，总之就是延迟1~2秒（主从同步完成，这个时间要根据主从同步的速度估算增加）再删除一次。


参考：

[保证缓存与数据库的数据一致性不是很容易](https://segmentfault.com/a/1190000037611692)

[Redis与数据库一致性](https://note.dolyw.com/cache/00-DataBaseConsistency.html#%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98-vs-%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98)


